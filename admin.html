<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - The Conclusion Daily</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .admin-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-btn {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #333;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-btn:hover {
            background: #5a6fd8;
            color: white;
            border-color: #5a6fd8;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 1rem;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .search-box {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .export-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .score-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .score-low {
            background: #dc3545;
        }

        .score-medium {
            background: #ffc107;
            color: #333;
        }

        .score-high {
            background: #28a745;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }

            .admin-title {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }

            .export-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .admin-header,
            .stats-grid,
            .tabs,
            .action-buttons,
            .export-section {
                display: none;
            }

            .tab-content {
                display: block !important;
                box-shadow: none;
                background: white;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">Admin Panel - The Conclusion Daily</h1>
            <p class="admin-subtitle">Manage users, view quiz results, and export data</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Registered Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="quizAttempts">0</div>
                <div class="stat-label">Quiz Attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">0%</div>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('users')">Users</button>
            <button class="tab-btn" onclick="showTab('attempts')">Quiz Attempts</button>
            <button class="tab-btn" onclick="showTab('analytics')">Analytics</button>
            <button class="tab-btn" onclick="showTab('export')">Export Data</button>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content active">
            <h2>Registered Users</h2>
            <input type="text" class="search-box" id="userSearch" placeholder="Search users by name, email, or mobile..." onkeyup="searchUsers()">
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
                <button class="btn btn-secondary" onclick="exportUsersCSV()">Export Users CSV</button>
                <button class="btn btn-danger" onclick="clearAllData()" id="clearDataBtn">Clear All Data</button>
            </div>

            <div class="table-container">
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>Registered</th>
                            <th>Last Login</th>
                            <th>Attempts</th>
                            <th>Best Score</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quiz Attempts Tab -->
        <div id="attempts-tab" class="tab-content">
            <h2>Quiz Attempts</h2>
            <input type="text" class="search-box" id="attemptSearch" placeholder="Search attempts by user or score..." onkeyup="searchAttempts()">
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
                <button class="btn btn-success" onclick="exportAttemptsCSV()">Export Attempts CSV</button>
            </div>

            <div class="table-container">
                <table class="data-table" id="attemptsTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Time Used</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="attemptsTableBody">
                        <!-- Attempts will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <h2>Quiz Analytics</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalAttempts">0</div>
                    <div class="stat-label">Total Quiz Attempts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueParticipants">0</div>
                    <div class="stat-label">Unique Participants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completionTime">0m</div>
                    <div class="stat-label">Avg. Completion Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate (50%+)</div>
                </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <h3>Score Distribution</h3>
                <div id="scoreChart" style="height: 300px; margin-top: 20px;">
                    <!-- Score chart will be rendered here -->
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Score distribution chart will appear here when data is available
                    </p>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
            <h2>Data Export</h2>
            <p>Export quiz data in various formats for analysis and reporting.</p>
            
            <div class="export-section">
                <h3>Export Options</h3>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportUsersJSON()">Export Users (JSON)</button>
                    <button class="btn btn-success" onclick="exportAttemptsJSON()">Export Attempts (JSON)</button>
                    <button class="btn btn-secondary" onclick="exportAllDataJSON()">Export All Data (JSON)</button>
                    <button class="btn btn-primary" onclick="exportUsersCSV()">Export Users (CSV)</button>
                    <button class="btn btn-success" onclick="exportAttemptsCSV()">Export Attempts (CSV)</button>
                </div>
            </div>

            <div class="export-section">
                <h3>Data Summary</h3>
                <div id="dataSummary">
                    <!-- Data summary will be populated here -->
                </div>
            </div>

            <div class="export-section">
                <h3>Backup & Restore</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="createBackup()">Create Backup</button>
                    <button class="btn btn-secondary" onclick="restoreBackup()">Restore Backup</button>
                    <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="handleBackupFile(this.files[0])">
                </div>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="no-data" style="display: none;">
            <h3>No Data Available</h3>
            <p>No users or quiz attempts found in the system.</p>
            <p>Users will appear here once they register and attempt the quiz.</p>
        </div>
    </div>

    <script>
        // Admin Panel JavaScript
        let allUsers = [];
        let allAttempts = [];

        // Initialize admin panel
        function initAdminPanel() {
            loadData();
            updateStatistics();
            showTab('users');
        }

        // Load data from localStorage
        function loadData() {
            try {
                allUsers = JSON.parse(localStorage.getItem('quizUsers')) || [];
                allAttempts = JSON.parse(localStorage.getItem('quizAttempts')) || [];
                
                // Show/hide no data message
                const noDataMessage = document.getElementById('noDataMessage');
                if (allUsers.length === 0 && allAttempts.length === 0) {
                    noDataMessage.style.display = 'block';
                } else {
                    noDataMessage.style.display = 'none';
                }
                
                renderUsersTable();
                renderAttemptsTable();
                updateDataSummary();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data from storage');
            }
        }

        // Update statistics
        function updateStatistics() {
            // User statistics
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('quizAttempts').textContent = allAttempts.length;
            
            // Calculate average score
            const totalScore = allAttempts.reduce((sum, attempt) => sum + attempt.percentage, 0);
            const avgScore = allAttempts.length > 0 ? Math.round(totalScore / allAttempts.length) : 0;
            document.getElementById('avgScore').textContent = avgScore + '%';
            
            // Completion rate (users who attempted vs total users)
            const usersWithAttempts = allUsers.filter(user => 
                user.quizResults && user.quizResults.length > 0
            ).length;
            const completionRate = allUsers.length > 0 ? Math.round((usersWithAttempts / allUsers.length) * 100) : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // Analytics statistics
            document.getElementById('totalAttempts').textContent = allAttempts.length;
            document.getElementById('uniqueParticipants').textContent = new Set(allAttempts.map(a => a.userId)).size;
            
            // Average completion time
            const totalTime = allAttempts.reduce((sum, attempt) => sum + (attempt.timeUsed || 0), 0);
            const avgTime = allAttempts.length > 0 ? Math.round(totalTime / allAttempts.length / 60) : 0;
            document.getElementById('completionTime').textContent = avgTime + 'm';
            
            // Success rate (50% or higher)
            const successfulAttempts = allAttempts.filter(attempt => attempt.percentage >= 50).length;
            const successRate = allAttempts.length > 0 ? Math.round((successfulAttempts / allAttempts.length) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Refresh data for the tab
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Render users table
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            allUsers.forEach(user => {
                const attempts = user.quizResults ? user.quizResults.length : 0;
                const bestScore = user.quizResults && user.quizResults.length > 0 
                    ? Math.max(...user.quizResults.map(r => r.percentage))
                    : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar">${user.name ? user.name.charAt(0).toUpperCase() : 'U'}</div>
                            <div>${user.name || 'N/A'}</div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>${user.mobile || 'N/A'}</td>
                    <td>${formatDate(user.registrationDate)}</td>
                    <td>${user.lastLogin ? formatDate(user.lastLogin) : 'Never'}</td>
                    <td>${attempts}</td>
                    <td>
                        ${bestScore > 0 ? `
                            <span class="score-badge ${getScoreClass(bestScore)}">${bestScore}%</span>
                        ` : 'N/A'}
                    </td>
                    <td>
                        <span style="color: ${user.isActive !== false ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            ${user.isActive !== false ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render attempts table
        function renderAttemptsTable() {
            const tbody = document.getElementById('attemptsTableBody');
            tbody.innerHTML = '';

            allAttempts.forEach(attempt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${attempt.userName || 'Unknown'}</td>
                    <td>${attempt.userId}</td>
                    <td>${attempt.score}/${attempt.total}</td>
                    <td>
                        <span class="score-badge ${getScoreClass(attempt.percentage)}">${attempt.percentage}%</span>
                    </td>
                    <td>${formatTime(attempt.timeUsed)}</td>
                    <td>${attempt.date}</td>
                    <td>${attempt.time}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewAttemptDetails('${attempt.userId}', '${attempt.timestamp}')">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Search functions
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function searchAttempts() {
            const searchTerm = document.getElementById('attemptSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#attemptsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Export functions
        function exportUsersJSON() {
            const dataStr = JSON.stringify(allUsers, null, 2);
            downloadFile(dataStr, 'quiz-users.json', 'application/json');
        }

        function exportAttemptsJSON() {
            const dataStr = JSON.stringify(allAttempts, null, 2);
            downloadFile(dataStr, 'quiz-attempts.json', 'application/json');
        }

        function exportAllDataJSON() {
            const allData = {
                users: allUsers,
                attempts: allAttempts,
                exportDate: new Date().toISOString(),
                totalUsers: allUsers.length,
                totalAttempts: allAttempts.length
            };
            const dataStr = JSON.stringify(allData, null, 2);
            downloadFile(dataStr, 'quiz-all-data.json', 'application/json');
        }

        function exportUsersCSV() {
            const headers = ['Name', 'Email', 'Mobile', 'Registered', 'Last Login', 'Attempts', 'Best Score'];
            const csvData = allUsers.map(user => [
                user.name || 'N/A',
                user.email,
                user.mobile || 'N/A',
                formatDate(user.registrationDate),
                user.lastLogin ? formatDate(user.lastLogin) : 'Never',
                user.quizResults ? user.quizResults.length : 0,
                user.quizResults && user.quizResults.length > 0 ? Math.max(...user.quizResults.map(r => r.percentage)) + '%' : 'N/A'
            ]);
            
            const csvContent = [headers, ...csvData].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            downloadFile(csvContent, 'quiz-users.csv', 'text/csv');
        }

        function exportAttemptsCSV() {
            const headers = ['User Name', 'Email', 'Score', 'Percentage', 'Time Used', 'Date', 'Time'];
            const csvData = allAttempts.map(attempt => [
                attempt.userName || 'Unknown',
                attempt.userId,
                `${attempt.score}/${attempt.total}`,
                attempt.percentage + '%',
                formatTime(attempt.timeUsed),
                attempt.date,
                attempt.time
            ]);
            
            const csvContent = [headers, ...csvData].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            downloadFile(csvContent, 'quiz-attempts.csv', 'text/csv');
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }

        function formatTime(seconds) {
            if (!seconds) return 'N/A';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }

        function getScoreClass(percentage) {
            if (percentage >= 80) return 'score-high';
            if (percentage >= 50) return 'score-medium';
            return 'score-low';
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function refreshData() {
            loadData();
            updateStatistics();
            alert('Data refreshed successfully!');
        }

        function clearAllData() {
            if (confirm('⚠️ ARE YOU SURE?\n\nThis will delete ALL user data and quiz attempts. This action cannot be undone!')) {
                localStorage.removeItem('quizUsers');
                localStorage.removeItem('quizAttempts');
                localStorage.removeItem('currentUser');
                alert('All data has been cleared!');
                loadData();
                updateStatistics();
            }
        }

        function updateDataSummary() {
            const summary = document.getElementById('dataSummary');
            summary.innerHTML = `
                <p><strong>Total Users:</strong> ${allUsers.length}</p>
                <p><strong>Total Quiz Attempts:</strong> ${allAttempts.length}</p>
                <p><strong>Data Last Updated:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>Storage Used:</strong> ${calculateStorageSize()} KB</p>
            `;
        }

        function calculateStorageSize() {
            let totalSize = 0;
            ['quizUsers', 'quizAttempts', 'currentUser'].forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    totalSize += new Blob([data]).size;
                }
            });
            return Math.round(totalSize / 1024);
        }

        function viewAttemptDetails(userId, timestamp) {
            const attempt = allAttempts.find(a => a.userId === userId && a.timestamp === timestamp);
            if (attempt) {
                alert(`Attempt Details:\n\nUser: ${attempt.userName}\nScore: ${attempt.score}/${attempt.total}\nPercentage: ${attempt.percentage}%\nTime: ${formatTime(attempt.timeUsed)}\nDate: ${attempt.date} ${attempt.time}`);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initAdminPanel);
    </script>
</body>
</html>